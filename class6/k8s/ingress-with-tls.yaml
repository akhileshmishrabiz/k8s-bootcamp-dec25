# HTTPS/SSL Ingress Configuration with TLS termination
# This creates an ALB with SSL certificate and HTTP to HTTPS redirect
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: student-portal-ingress
  namespace: student-portal
  annotations:
    # Create an internet-facing ALB (public access)
    alb.ingress.kubernetes.io/scheme: "internet-facing"
    # Use IP mode for better compatibility with Fargate and pod networking
    alb.ingress.kubernetes.io/target-type: "ip"
    # Health check path - ALB will check this endpoint for service health
    alb.ingress.kubernetes.io/healthcheck-path: "/login"

    # SSL/TLS Configuration
    # Listen on both HTTP (80) and HTTPS (443) ports
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    # Automatically redirect HTTP traffic to HTTPS
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    
    # SSL Security Policy - ensures strong encryption
    alb.ingress.kubernetes.io/ssl-policy: "ELBSecurityPolicy-TLS-1-2-2017-01"
    # AWS ACM Certificate ARN - replace with your certificate ARN
    # NOTE: Ensure this certificate covers your domain and is in the correct AWS region
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-south-1:879381241087:certificate/b1a85a14-36e2-491e-b117-479bcf804012
    
    # HTTP to HTTPS redirect action configuration
    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": {"Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'
    
spec:
  # Use the ALB ingress class defined above
  ingressClassName: "alb"
  
  # TLS configuration for certificate management
  tls:
  - hosts:
    - "eks.akhileshmishra.tech"  # Your app subdomain
  
  rules:
  # Single subdomain rule - all traffic for app.akhileshmishra.tech
  - host: "eks.akhileshmishra.tech"  # Your app subdomain
    http:
      paths:
      # Route API calls to backend service (must come first for priority)
      - path: /
        pathType: Prefix  # Matches /api, /api/, /api/users, etc.
        backend:
          service:
            name: student-portal
            port:
              number: 8080
     